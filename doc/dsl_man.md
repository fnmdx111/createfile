
用于时间规则描述的DSL
====

为了使得用户能够对单个文件项内（inter-entry）的所具有的属性进行关系上的描述，本项目内部集成了一个用于时间规则描述的DSL。如果用户需要高级规则（如文件项间（intra-entry）的关系，请使用高级扩展

语法
----

本DSL语法元素较少，包括：

* 语义上代表一个文件项的占位符`_`
* 各种运算符，如`<`，`==`等
* 有限的快捷函数，如`attr_eq`，`ctg_eq`等

这些语法元素之间可以在有意义的基础上任意组合。


文件项占位符
----

文件项占位符代表任意一个应用于这个规则的文件项。其属性用点运算符获取，如要描述NTFS文件项（即MFT记录）的$SI创建时间，其对应的DSL表达应为`_.si_create_time`或使用其简写形式`_.si_c`。请注意，本DSL **大小写敏感** ，但每种属性和其简写形式都有对应的大写形式，即`_.si_c`或`_.SI_C`用来描述$SI创建时间也合法。

> 内部实现细节：
>
> *   每个时间都是一个Python的`datetime.datetime`对象，其所有属性与实例方法都可以在本DSL中使用。
>
>     如获取一个时间的日期信息，其对应的DSL表达为`_.xxx_time.date()`，更多方法与属性请参阅Python 3.4手册。
>
> *   你也可以在DSL中任意合法的位置创建一个datetime、`datetime.timedelta`、`datetime.date`或`datetime.time`对象，构造对象的语法与Python构造对象的语法相同。
>
>     如构造一个2秒的timedelta对象，其对应的DSL表达为`timedelta(seconds=2)`。对于datetime和timedelta，本DSL提供了简写形式，分别为`dt`与`td`。


运算符
----

可比较的属性之间可以用运算符来进行逻辑或算术运算。本DSL支持以下运算：

*   +，-：与Python的+，-相同

*   &，|：分别代表逻辑与，逻辑或。可以用来描述两个子规则之间的关系，请注意， **子规则必须用小括号括起来** 。

    如要描述A属性大于B属性，且A属性小于C属性，其对应的DSL表达为`(_.A > _.B) & (_.A < _.C)`。如果用户在使用这两个运算符中遇到了规则应用不正确的情况，请一定检查子规则是否有括号，是否少括号。

*   ==，!=，>，>=，<，<=：与Python对应的运算符相同。请注意，这些运算符对于datetime对象是 **模糊** 的，对于其它对象是 **严格** 的。对datetime对象引入模糊运算的理由是，很多情况下我们对微秒级的数据并不感兴趣，因此引入需要引入一种方式将微秒级数据隐藏起来。

    模糊应用是指，两个比较对象间只有其大小在特定误差内（或外）才会继续比较，在本DSL中这个值为2秒，否则返回值直接为假。如

        dt(year=1, month=1, day=1, second=5) == dt(year=1, month=1, day=1, second=3)

    将返回真，因为它们之间只差2秒。若将上面两个对象进行大于比较，则将返回假，因为后一个对象并不比前一个对象 **小2秒** 。

> 内部实现细节：
>
> 用户可以设置`judge.misc:approxiamte_seconds`以调节模糊运算的误差阈值。

快捷函数
----

快捷函数可以用来实现一些运算符所表达不了的语义，或用来简化一些规则的描述。调用快捷函数的语法为

    func(attr1, attr2, attr3, ...)

与Python调用函数语法类似。其中`attr_n`表示任意一种属性。如求$FN创建时间与$SI创建时间的最小值，其对应的DSL表达为`min_('fn_create_time', 'si_create_time')`。

由于实际应用中规则的描述偏重于固定的几种属性，如FAT32的访问日期（`access_date`），NTFS的$FN修改时间（`fn_modify_time`）等，本DSL为这些常用属性提供了简写。如上面例子的简写形式为`min_(fn_c, si_c)`（请注意，两个属性 **没有引号** ）。要查看所有的简写形式，请查阅`judge.abbr`。

本DSL支持的快捷函数有（中括号内为简写形式）：

*   `max_`，`min_`：获得参数中的最大值，最小值。

*   `approx_eq`[`axe`]： 模糊相等（近似），这个函数接受任意个参数，在对它们所有值进行模糊相等计算后返回一个布尔值。这个函数还接受一个`error`关键字参数，用于设置误差大小，误差必须为一个timedelta对象，该关键字参数默认值为`timedelta(seconds=2)`。

    在实际使用中，为了简便，用户可以以`fn_all`（或其大写形式）代替所有$FN下的时间属性，以`si_all`（或其大写形式）代替所有的$SI下的时间属性。

    > 内部实现细节：
	>
	> 为了避免比较结果出现漂移（即若a1与a2模糊相等，a2与a3模糊相等，a1与a3不一定相等，因为这两个值之间可能有两个误差单位，即出现了漂移），所有参数都是与第一个参数进行比较的。在使用中，请谨记这一点，以避免时间规则出现偏差。

*   `ntfs_mace_congruent`[`nmc`]：判断NTFS的8个时间是否全模糊相等。

*   `ctg_eq`[`ce`]：判断一种操作时间在NTFS的2个属性中是否全模糊相等。可用参数有

    |标准写法      |小写简写|大写简写|意义        |
    |:----------:|:-----:|:----:|:---------:|
    | `'modify'` | `_m_` | `M`  | 修改时间    |
	| `'access'` | `_a_` | `A`  | 访问时间    |
	| `'create'` | `_c_` | `C`  | 创建时间    |
	| `'mft'`    | `_e_` | `E`  | MFT修改时间 |

*   `attr_eq`[`ate`]：判断一种NTFS属性内的4个时间是否全模糊相等。可用参数有

    |标准写法  |小写简写|大写简写|意义       |
    |:------:|:----:|:----:|:---------:|
    | `'si'` | `si` | `SI` | 标准信息属性 |
	| `'fn'` | `fn` | `FN` | 文件名属性  |


例子
----

请参阅`judge.built_in`包下的`fat32.py`与`ntfs.py`。

